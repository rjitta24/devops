# Create a Network Security Group 

resource "azurerm_network_security_group" "vm_nsg" { 

  name                = "${random_pet.resource_prefix.id}-nsg" 

  location            = azurerm_resource_group.core_group.location 

  resource_group_name = azurerm_resource_group.core_group.name 

  

  # Allow SSH (port 22) from any source (for management access) 

  security_rule { 

    name                       = "AllowSSH" 

    priority                   = 1001 

    direction                  = "Inbound" 

    access                     = "Allow" 

    protocol                   = "Tcp" 

    source_port_range          = "*" 

    destination_port_range     = "22" 

    source_address_prefix      = "*" 

    destination_address_prefix = "*" 

  } 

  

  # Allow HTTP (port 80) from any source (for web traffic) 

  security_rule { 

    name                       = "AllowHTTP" 

    priority                   = 1002 

    direction                  = "Inbound" 

    access                     = "Allow" 

    protocol                   = "Tcp" 

    source_port_range          = "*" 

    destination_port_range     = "80" 

    source_address_prefix      = "*" 

    destination_address_prefix = "*" 

  } 

  

  # Allow HTTPS (port 443) from any source (for secure web traffic) 

  security_rule { 

    name                       = "AllowHTTPS" 

    priority                   = 1003 

    direction                  = "Inbound" 

    access                     = "Allow" 

    protocol                   = "Tcp" 

    source_port_range          = "*" 

    destination_port_range     = "443" 

    source_address_prefix      = "*" 

    destination_address_prefix = "*" 

  } 

} 

 

# Associate the NSG with the VM's Network Interface 

resource "azurerm_network_interface_security_group_association" "vm_nic_nsg" { 

  network_interface_id      = azurerm_network_interface.vm_nic.id 

  network_security_group_id = azurerm_network_security_group.vm_nsg.id 

} 
